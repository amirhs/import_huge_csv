# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
    csv_upload_dir: '%kernel.project_dir%/var/uploads/csv'

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'

    # add more service definitions when explicit configuration is needed
    # please note that last definitions always *replace* previous ones

    App\Service\CSVUploadService:
        arguments:
            $csvUploadDir: '%csv_upload_dir%'

    App\Service\CsvImportService:
        arguments:
            $csvUploadDir: '%csv_upload_dir%'

    # App\MessageHandler\ProcessCsvBatchJobHandler:
    #     arguments:
    #         $connection: '@doctrine.dbal.default_connection'
    #         $logger: '@logger'



    App\Domain\Repository\CsvBatchRepository:
        class: App\Infrastructure\Persistence\DoctrineCsvBatchRepository
        arguments:
            - '@doctrine.orm.entity_manager'
            
    # Message handlers
    App\Infrastructure\Messaging\ProcessCsvBatchHandler:
        arguments:
            - '@App\Domain\Repository\CsvBatchRepository'
        tags: ['messenger.message_handler']

    # Repository implementations
    App\Domain\Repository\CsvFileRepository:
        class: App\Infrastructure\Persistence\DoctrineCsvFileRepository
        arguments:
            - '@doctrine.orm.entity_manager'
            
    # Application services
    App\Application\Service\CSVUploadService:
        arguments:
            - '%csv_upload_dir%'
            - '@App\Domain\Repository\CsvFileRepository'

    # Command and Query buses
    App\Application\Bus\CommandBusInterface:
        class: App\Infrastructure\Bus\SimpleCommandBus
        arguments:
            - '@service_container'
            - [] # handler mapping
            
    App\Application\Bus\QueryBusInterface:
        class: App\Infrastructure\Bus\SimpleQueryBus
        arguments:
            - '@service_container'
            - [] # handler mapping
            
    # Command handlers
    App\Application\CommandHandler\:
        resource: '../src/Application/CommandHandler'
        autowire: true
        
    # Query handlers
    App\Application\QueryHandler\:
        resource: '../src/Application/QueryHandler'
        autowire: true